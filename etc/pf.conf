# --- Sistema de FIREWALL SimaTEF - Equinix-SP1
#
# --- Packet Firewall - Default: DROP ALL
# --- Versao Producao: 4.3 01/09/18 07:00H
# --- Por: Ricardo Ferreira - rnhc1000@hotmail.com
# ---
# --- Changelog:
# --- Versao: 1.0 15/05/08 17:00H - setup inicial
# --- Versao: 1.1 20/12/08 17:00H - Controle Granular Conexoes SSH
# --- Versao: 1.2 05/07/09 16:00H - autoBlackList - SSH, SMTP e WWW
# --- Versao: 1.3 05/12/09 15:00H - Alteracao Logs das Regras
# --- Versao: 1.4 21/04/10 14:00H - Pilha Dupla IPv4/IPv6
# --- Versao: 1.5 15/11/10 13:00H - Troca Trafego IPv6 - PTT
# --- Versao: 1.6 06/05/11 19:00H - Trafego WWW, SMTP - autoBlackList
# --- Versao: 1.7 07/12/11 18:00H - Revisao Trimestral de Regras PCI-Item 1.1.X
# --- Versao: 1.8 06/05/12 20:00H - Revisao Trimestral de Regras PCI-Item 1.1.X
# --- Versao: 1.9 05/10;12 22:00H - Revisao Trimestral de Regras PCI-Item 1.1.X
# --- Versao: 2.0 05/04/13 23:00H - Ativacao BGP-4 AS 7738
# --- Versao: 2.1 07/09/13 15:00H - Inclui hosts:
# --- ---       		    avs.simatef.com.br
# --- ---       		    log.simatef.com.br
# --- ---       		    connecta.simatef.com.br
# 
# --- MACROS
# ---
# --- Interfaces Fisicas 
ifaceNetSP="lagg0"
ifaceTefSP="lagg1"
ifaceLyraX25="em1"

# --- Servicos  
svcDNS="{ 53 }"
svcNTP="{ 123 }"
svcSSH="{ 22222 }"
svcHTTP="{ 80 }"
svcHTTPS="{ 443 }"
svcSMTP="{ 25 }"
svcRDP="{ 3389 }"


#RealPlayer aware Firewalls
svcRSTP="{ 554, 7070 }"

# --- Ajuste Firewall 
icmpType ="icmp-type 8 code 0"
tcpState="modulate state"
udpState="keep state"

# --- TABELAS
table <ALOG> const { \
                        200.198.176.216/32 \
}


table <redeAlog6> const { \

                        2001:12E8:2:D::210, \
                        2001:12E8:2:D::212, \
                        2001:12E8:2:D::214, \
                        2001:12E8:2:D::216, \
                        2001:12E8:2:D::218, \
                        2001:12E8:2:D::220, \
                        2001:12E8:2:D::222 \
}



table <vspSoftNEX> { \
			172.31.254.201/32, \
			172.31.254.202/32, \
			172.31.254.203/32, \
			172.31.254.204/32, \
			172.31.254.205/32, \
			172.31.254.206/32  \
}



table <autoBlackList>	persist 
table <blackList> 	persist	file "/etc/pf.files/blackList"
table <privNets> 	persist	file "/etc/pf.files/rfc1918"
table <spammers> 	persist	file "/etc/pf.files/spammers"
table <srvNTP> 		const 	file "/etc/pf.files/ntpBR"
table <cidrBR> 		persist	file "/etc/pf.files/cidrBR"
table <cidrBR6>		persist	file "/etc/pf.files/cidrBR6"
table <cidrUSA>		persist file "/etc/pf.files/cidrUSA"

# --- OPCOES
set block-policy drop
set skip on { lo0 }
set limit states 20000
set loginterface lagg0 

# --- SCRUB
scrub on $ifaceNetSP random-id no-df fragment reassemble reassemble tcp

# --- rdr SP3
rdr on $ifaceTefSP proto tcp from 192.168.235.248/29 to 172.31.250.250 port 9010 -> 172.31.255.243 port 9010
rdr on $ifaceTefSP proto tcp from 192.168.245.248/29 to 172.31.240.250 port 9010 -> 172.31.255.242 port 9010

# --- NAT SimaTEF
nat on $ifaceNetSP  inet from ! ($ifaceNetSP) to any -> ($ifaceNetSP)

# --- BLACKLIST
block in quick log from { <blackList>, <autoBlackList> }

# --- SPAMMERS
block in quick log from <spammers>

# --- NMAP
block in log quick proto tcp flags FUP/WEUAPRSF
block in log quick proto tcp flags WEUAPRSF/WEUAPRSF
block in log quick proto tcp flags SRAFU/WEUAPRSF
block in log quick proto tcp flags /WEUAPRSF
block in log quick proto tcp flags SR/SR
block in log quick proto tcp flags SF/SF

# --- DEFAULT
block in log all

# --- SSL/TLS --- TEF 
pass in quick log on $ifaceNetSP inet  proto { udp } from <cidrBR>  to <Pascal>  port $sslPorts $udpState
pass in quick log on $ifaceNetSP inet  proto { udp } from <cidrUSA> to <Pascal>  port $sslPorts $udpState
pass in quick log on $ifaceNetSP inet6 proto { udp } from <cidrBR6> to <Pascal6> port $sslPorts $udpState

# --- SSH --- Entrante
pass in quick log on $ifaceNetSP inet  proto { tcp } from <cidrBR> to <Pascal>   port $svcSSH $tcpState 
#	(max-src-conn-rate 5/10, overload <autoBlackList> flush global) 
pass in quick log on $ifaceNetSP inet6 proto { tcp } from <cidrBR6> to <Pascal6> port $svcSSH $tcpState 
#	(max-src-conn-rate 5/10, overload <autoBlackList> flush global) 

# --- HTTP/HTTPS
#pass in quick log(all) on $ifaceNetSP inet proto { tcp }  from any  to <Pascal>  port $svcHTTPS $tcpState # (max-src-conn-rate 5/10, overload <autoBlackList> flush global) 
#pass in quick log(all) on $ifaceNetSP inet6 proto { tcp } from any  to <Pascal6> port $svcHTTPS $tcpState # (max-src-conn-rate 5/10, overload <autoBlackList> flush global) 
#pass in quick log(all) on $ifaceNetSP inet proto { tcp }  from any  to <Pascal>  port $svcHTTP  $tcpState # (max-src-conn-rate 5/10, overload <autoBlackList> flush global) 
#pass in quick log(all) on $ifaceNetSP inet6 proto { tcp } from any  to <Pascal6> port $svcHTTP  $tcpState # (max-src-conn-rate 5/10, overload <autoBlackList> flush global) 
#pass out quick log(all) on $ifaceNetSP inet proto  { tcp } from <Pascal> to <tefStone> port $svcHTTPS  no state 

pass in  quick log(all) on $ifaceNetSP inet proto  { tcp } from <cidrBR>  to <Pascal>  port $svcHTTPS $tcpState # (max-src-conn-rate 5/10, overload <autoBlackList> flush global) 
pass in  quick log(all) on $ifaceNetSP inet6 proto { tcp } from <cidrBR6> to <Pascal6> port $svcHTTPS $tcpState # (max-src-conn-rate 5/10, overload <autoBlackList> flush global) 
pass in  quick log(all) on $ifaceNetSP inet proto  { tcp } from <cidrBR>  to <Pascal>  port $svcHTTP  $tcpState # (max-src-conn-rate 5/10, overload <autoBlackList> flush global) 
pass in  quick log(all) on $ifaceNetSP inet6 proto { tcp } from <cidrBR6> to <Pascal6> port $svcHTTP  $tcpState # (max-src-conn-rate 5/10, overload <autoBlackList> flush global) 

pass in  quick log(all) on $ifaceTefSP   inet proto { tcp } from <prvProxy>  to <prvPascal> port $svcHTTP $tcpState   

# --- SPOOF
antispoof for { lagg0 lagg1 em1 } inet
