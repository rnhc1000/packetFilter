# --- Packet Firewall - Default: DROP ALL
# --- Versao Producao: 4.3 01/09/18 07:00H
# --- Por: Ricardo Ferreira - rnhc1000@hotmail.com
# ---
# --- Changelog:
# --- Versao: 1.0 15/05/08 17:00H - setup inicial
# 
# --- MACROS
# ---
# --- Interfaces Fisicas 
ifaceNet="lagg0"
ifaceLocal="lagg1"

# --- Servicos  
svcDNS="{ 53 }"
svcNTP="{ 123 }"
svcSSH="{ 22222 }"
svcHTTP="{ 80 }"
svcHTTPS="{ 443 }"
svcSMTP="{ 25 }"
svcRDP="{ 3389 }"

#RealPlayer aware Firewalls
svcRSTP="{ 554, 7070 }"

# --- Ajuste Firewall 
icmpType ="icmp-type 8 code 0"
tcpState="modulate state"
udpState="keep state"

# --- TABELAS

table <tabela1> const { \

                        2001:0:2:D::210, \
                        2001:0:2:D::212, \
                        2001:0:2:D::214, \
                        2001:0:2:D::216, \
                        2001:0:2:D::218, \
                        2001:0:2:D::220, \
                        2001:0:2:D::222 \
}

table <tabela2> { \
			172.33.255.201/32, \
			172.33.255.202/32, \
			172.33.255.203/32, \
			172.33.255.204/32, \
			172.33.255.205/32, \
			172.33.254.206/32  \
}

table <autoBlackList>	persist 
table <blackList> 	persist	file "/etc/pf.files/blackList"
table <privNets> 	persist	file "/etc/pf.files/rfc1918"
table <spammers> 	persist	file "/etc/pf.files/spammers"
table <srvNTP> 		const 	file "/etc/pf.files/ntpBR"
table <cidrBR> 		persist	file "/etc/pf.files/cidrBR"
table <cidrBR6>		persist	file "/etc/pf.files/cidrBR6"
table <cidrUSA>		persist file "/etc/pf.files/cidrUSA"

# --- OPCOES
set block-policy drop
set skip on { lo0 }
set limit states 20000
set loginterface lagg0 

# --- SCRUB
scrub on $ifaceNet random-id no-df fragment reassemble reassemble tcp

# --- rdr 
rdr on $ifaceLocalSP proto tcp from 192.168.235.248/29 to 172.33.250.250 port 9010 -> 172.33.255.243 port 9010
rdr on $ifaceLocalSP proto tcp from 192.168.245.248/29 to 172.33.240.250 port 9010 -> 172.33.255.242 port 9010

# --- NAT 
nat on $ifaceNet  inet from ! ($ifaceNet) to any -> ($ifaceNet)

# --- BLACKLIST
block in quick log from { <blackList>, <autoBlackList> }

# --- SPAMMERS
block in quick log from <spammers>

# --- NMAP
block in log quick proto tcp flags FUP/WEUAPRSF
block in log quick proto tcp flags WEUAPRSF/WEUAPRSF
block in log quick proto tcp flags SRAFU/WEUAPRSF
block in log quick proto tcp flags /WEUAPRSF
block in log quick proto tcp flags SR/SR
block in log quick proto tcp flags SF/SF

# --- DEFAULT
block in log all

# --- TLS
pass in quick log on $ifaceNet inet  proto { udp } from <cidrBR>  to <Pascal>  port $sslPorts $udpState
pass in quick log on $ifaceNet inet  proto { udp } from <cidrUSA> to <Pascal>  port $sslPorts $udpState
pass in quick log on $ifaceNet inet6 proto { udp } from <cidrBR6> to <Pascal6> port $sslPorts $udpState

# --- SSH 
pass in quick log on $ifaceNet inet  proto { tcp } from <cidrBR> to <Pascal>   port $svcSSH $tcpState \
	(max-src-conn-rate 5/10, overload <autoBlackList> flush global) 
pass in quick log on $ifaceNet inet6 proto { tcp } from <cidrBR6> to <Pascal6> port $svcSSH $tcpState \
	(max-src-conn-rate 5/10, overload <autoBlackList> flush global) 

# --- HTTP/HTTPS
#pass in quick log(all) on $ifaceNet inet proto { tcp }  from any  to <Pascal>  port $svcHTTPS $tcpState (max-src-conn-rate 5/10, overload <autoBlackList> flush global) 
#pass in quick log(all) on $ifaceNet inet6 proto { tcp } from any  to <Pascal6> port $svcHTTPS $tcpState (max-src-conn-rate 5/10, overload <autoBlackList> flush global) 
#pass in quick log(all) on $ifaceNet inet proto { tcp }  from any  to <Pascal>  port $svcHTTP  $tcpState (max-src-conn-rate 5/10, overload <autoBlackList> flush global) 
#pass in quick log(all) on $ifaceNet inet6 proto { tcp } from any  to <Pascal6> port $svcHTTP  $tcpState (max-src-conn-rate 5/10, overload <autoBlackList> flush global) 

pass in  quick log(all) on $ifaceNet inet proto  { tcp } from <cidrBR>  to <Pascal>  port $svcHTTPS $tcpState (max-src-conn-rate 5/10, overload <autoBlackList> flush global) 
pass in  quick log(all) on $ifaceNet inet6 proto { tcp } from <cidrBR6> to <Pascal6> port $svcHTTPS $tcpState (max-src-conn-rate 5/10, overload <autoBlackList> flush global) 
pass in  quick log(all) on $ifaceNet inet proto  { tcp } from <cidrBR>  to <Pascal>  port $svcHTTP  $tcpState (max-src-conn-rate 5/10, overload <autoBlackList> flush global) 
pass in  quick log(all) on $ifaceNet inet6 proto { tcp } from <cidrBR6> to <Pascal6> port $svcHTTP  $tcpState (max-src-conn-rate 5/10, overload <autoBlackList> flush global) 

# --- SPOOF
antispoof for { lagg0 lagg1 em1 } inet
